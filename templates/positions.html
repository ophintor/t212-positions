<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Papishares</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        body {
            font-family: 'Helvetica', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #121212;
            color: #e0e0e0;
            line-height: 1.6;
            font-size: 16px;
        }
        h1 {
            text-align: center;
            margin: 20px 0;
            color: #ffffff;
            font-size: 32px;
        }
        h2 {
            text-align: center;
            margin: 10px 0;
            color: #cccccc;
            font-size: 22px;
        }
        table {
            width: 90%;
            margin: 20px auto;
            border-collapse: collapse;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
            background-color: #1e1e1e;
            font-size: 15px;
        }

        table#orders-table {
            width: 50%;
            margin: 20px auto;
            border-collapse: collapse;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
            background-color: #1e1e1e;
            font-size: 15px;
        }
        th, td {
            border: 1px solid #333;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #007BFF;
            color: white;
            text-transform: uppercase;
            font-size: 16px;
        }
        tr:nth-child(even) { background-color: #2a2a2a; }
        tr:hover { background-color: #333333; }
        td { font-size: 16px; }
        td:nth-child(6) { font-weight: bold; }
        td:last-child { text-align: center; }
        p {
            text-align: center;
            font-size: 16px;
            color: #999;
        }
        .mono {
            font-family: 'Monaco', 'Menlo', monospace;
        }
        .subtle-link {
            color: #bbb;
            text-decoration: none;
            border-bottom: 1px solid transparent;
        }

        .subtle-link:hover {
            color: #ddff00;
            border-bottom: 1px solid #ddff00;
        }
    </style>
</head>
<body>
    <h1>üßòüèΩ‚Äç‚ôÇÔ∏è Current Positions</h1>
    <h2 id="total-risk">Total risk: --</h2>
    <p id="last-updated"><strong>Last updated:</strong>--</p>
    <p>[ <a class="subtle-link" href="/entries">Check potential entries</a> ]</p>

    <table>
        <thead>
            <tr>
                <th style="text-align: center;width: 7%;">Ticker</th>
                <th style="text-align: center;width: 20%;">Name</th>
                <th style="text-align: center;width: 7%;">Quantity</th>
                <th style="text-align: center;width: 7%;">Purchased Price</th>
                <th style="text-align: center;width: 7%;">Current Price</th>
                <th style="text-align: center;width: 7%;">Max Price</th>
                <th style="text-align: center;width: 14%;">Auto Stop-Loss</th>
                <th style="text-align: center;width: 7%;">Manual Stop-Loss</th>
                <th style="text-align: center;width: 14%;">Current P/L</th>
                <th style="text-align: center;width: 5%;">MACD signal</th>
                <th style="text-align: center;width: 5%;">MACD x-over</th>
            </tr>
        </thead>
        <tbody id="positions">
            <tr><td colspan="11">Loading...</td></tr>
        </tbody>
    </table>

    <h1>üí∞ Pending Buy Orders</h1>
    <table id="orders-table">
        <thead>
            <tr>
                <th style="text-align: center;width: 8%;">Ticker</th>
                <th style="text-align: center;width: 20%;">Name</th>
                <th style="text-align: center;width: 7%;">Currency</th>
                <th style="text-align: center;width: 9%;">Quantity</th>
                <th style="text-align: center;width: 10%;">Limit Price</th>
            </tr>
        </thead>
        <tbody id="orders">
            <tr><td colspan="6">Loading...</td></tr>
        </tbody>
    </table>

    <script>
    let previousData = {};

    async function fetchData() {
        try {
            const res = await fetch('/positions');
            if (!res.ok) throw new Error("HTTP error " + res.status);
            const data = await res.json();
            console.log("Received data:", data);  // Debug log
            console.log("total_risk value:", data.total_risk);  // Debug log
            const positionsData = data.positions;
            const total_risk = data.total_risk;
            const now = new Date();

            document.getElementById("last-updated").textContent = "Last updated: " + now.toLocaleTimeString();
            document.getElementById("total-risk").textContent = "Total risk: " + total_risk.toFixed(2) + "%";

            if (total_risk > 7.0 ){
                document.getElementById("total-risk").style.color = "red";
            } else {
                document.getElementById("total-risk").style.color = "lightgreen";
            }

            const tbody = document.getElementById("positions");
            tbody.innerHTML = "";

            positionsData.forEach(position => {
                let profitColor = "inherit";
                if (position.profit_pct > 3) profitColor = "rgb(0, 255, 0)";
                else if (position.profit_pct > 2) profitColor = "rgb(0, 225, 0)";
                else if (position.profit_pct > 1) profitColor = "rgb(0, 195, 0)";
                else if (position.profit_pct > 0) profitColor = "rgb(0, 165, 0)";
                else if (position.profit_pct < -3) profitColor = "rgb(255, 0, 0)";
                else if (position.profit_pct < -2) profitColor = "rgb(225, 0, 0)";
                else if (position.profit_pct < -1) profitColor = "rgb(195, 0, 0)";
                else if (position.profit_pct < 0) profitColor = "rgb(165, 0, 0)";

                let profit_amount = 0
                if (position.currency == "GBX") {
                    price_currency = "p"
                    profit_currency = "¬£"
                    profit_amount = ((position.current_price - position.average_price) * position.quantity / 100).toFixed(2);
                } else if (position.currency == "GBP") {
                    profit_currency = price_currency = "¬£"
                    profit_amount = ((position.current_price - position.average_price) * position.quantity).toFixed(2);
                } else {
                    profit_currency = price_currency = "$"
                    profit_amount = ((position.current_price - position.average_price) * position.quantity).toFixed(2);
                }

                let stopLossColor = "inherit";
                if (position.profit_pct > position.stop_loss_percentage) stopLossColor = "rgb(0, 225, 0)";
                else if (position.profit_pct < position.stop_loss_percentage) stopLossColor = "rgb(225, 0, 0)";

                if (position.manual_stop_loss_price !== null) {
                    stopLossColor = "gray";
                    manual_stop_loss_color = "rgb(225, 0, 0)";
                    manual_stop_loss_price = price_currency + position.manual_stop_loss_price.toLocaleString();
                } else {
                    manual_stop_loss_price = "";
                    manual_stop_loss_color = "inherit";
                }

                let profitText = `${profit_currency}${profit_amount.toLocaleString()} (${position.profit_pct}%) `;
                if (position.profit_pct > 0) profitText += `üî•`;
                else if (position.profit_pct < 0) profitText += `üôÄ`;
                else if (position.profit_pct == 0) profitText += `üòê`;

                let priceColor = "yellow";
                const prevPrice = previousData[position.ticker]?.current_price;
                if (prevPrice !== undefined) {
                    if (position.current_price > prevPrice) priceColor = "lime";
                    else if (position.current_price < prevPrice) priceColor = "red";
                }

                let macd_signal = "";
                let macd_crossover = "";
                if (position.macd_signal == "BULLISH") macd_signal = "üü¢"; else macd_signal = "üî¥";

                if (position.macd_crossover == "BULLISH") macd_crossover = "üü¢";
                else if (position.macd_crossover == "BEARISH") macd_crossover = "üî¥";
                else macd_crossover = "‚ö™Ô∏è";

                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td class="mono" style="text-align: center;"><strong>${position.short_name}</strong></td>
                    <td><strong>${position.name}</strong></td>
                    <td class="mono" style="text-align: right;">${position.quantity.toLocaleString()}</td>
                    <td class="mono" style="text-align: right;">${price_currency}${position.average_price.toLocaleString()}</td>
                    <td class="mono" style="text-align: right; color: ${priceColor};">${price_currency}${position.current_price.toLocaleString()}</td>
                    <td class="mono" style="text-align: right;">${price_currency}${position.max_price.toLocaleString()}</td>
                    <td class="mono" style="text-align: right; color: ${stopLossColor};">${price_currency}${position.stop_loss_price.toLocaleString()} (${position.stop_loss_percentage}%)</td>
                    <td class="mono" style="text-align: right; color: ${manual_stop_loss_color};">${manual_stop_loss_price}</td>
                    <td class="mono" style="text-align: right; color: ${profitColor};">${profitText}</td>
                    <td class="mono" style="text-align: center;">${macd_signal}</td>
                    <td class="mono" style="text-align: center;"">${macd_crossover}</td>
                `;
                tbody.appendChild(tr);

                if (priceColor) {
                    // setTimeout(() => {
                        tr.cells[4].style.color = "yellow";
                    // }, 600);
                }
                previousData[position.ticker] = { current_price: position.current_price };
            });

            // fetch orders
            const ordersRes = await fetch('/orders');
            if (!ordersRes.ok) throw new Error("HTTP error " + ordersRes.status);
            const ordersData = await ordersRes.json();
            const ordersBody = document.getElementById("orders");
            ordersBody.innerHTML = "";

            if (ordersData.length === 0) {
                ordersBody.innerHTML = `<tr><td colspan="6" style="text-align:center;">No orders found</td></tr>`;
            } else {
                ordersData.forEach(order => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td class="mono" style="text-align: center;">${order.ticker}</td>
                        <td>${order.name}</td>
                        <td style="text-align: center;">${order.currency}</td>
                        <td class="mono" style="text-align: right;">${order.quantity}</td>
                        <td class="mono" style="text-align: center;">${order.limit_price}</td>
                    `;
                    ordersBody.appendChild(tr);
                });
            }

        } catch (err) {
            console.error("Fetch error:", err);
        }
    }

    setInterval(fetchData, 30000);
    fetchData();
    </script>
</body>
</html>
