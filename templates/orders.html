<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Papishares</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        body {
            font-family: 'Helvetica', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #121212;
            color: #e0e0e0;
            line-height: 1.6;
            font-size: 16px; /* Increased font size */
        }

        h1 {
            text-align: center;
            margin: 20px 0;
            color: #ffffff;
            font-size: 32px; /* Increased font size */
        }

        table {
            width: 90%;
            margin: 20px auto;
            border-collapse: collapse;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
            background-color: #1e1e1e;
            font-size: 15px; /* Increased font size */
        }

        th, td {
            border: 1px solid #333;
            padding: 12px;
            text-align: left;
        }

        th {
            background-color: #007BFF;
            color: white;
            text-transform: uppercase;
            font-size: 16px;
        }

        tr:nth-child(even) {
            background-color: #2a2a2a;
        }

        tr:hover {
            background-color: #333333;
        }

        td {
            font-size: 16px;
        }

        td:nth-child(6) {
            font-weight: bold;
        }

        td:last-child {
            text-align: center;
        }

        p {
            text-align: center;
            font-size: 16px;
            color: #999;
        }
    </style>
</head>
<body>
    <h1>Current Positions</h1>
    <table>
        <thead>
            <tr>
                <th style="text-align: center;width: 9%;">Ticker</th>
                <th style="text-align: center;width: 19%;">Name</th>
                <th style="text-align: center;width: 9%;">Quantity</th>
                <th style="text-align: center;width: 9%;">Currency</th>
                <th style="text-align: center;width: 10%;">Current Price</th>
                <th style="text-align: center;width: 10%;">Purchased Price</th>
                <th style="text-align: center;width: 9%;;">Current P/L %</th>
                <th style="text-align: center;width: 14%;">Recommended Stop-Loss</th>
                <th style="text-align: center;width: 11%;">Current Stop-Loss</th>
            </tr>
        </thead>
        <tbody id="positions">
            <tr><td colspan="10">Loading...</td></tr>
        </tbody>
    </table>
    <div id="last-updated" style="text-align: center; font-size: 14px;">Last updated: --</div>

    <script>
    let previousData = {};
    async function fetchData() {
        try {
            const res = await fetch('/data');
            if (!res.ok) throw new Error("HTTP error " + res.status);
            const data = await res.json();
            const now = new Date();
            document.getElementById("last-updated").textContent = "Last updated: " + now.toLocaleTimeString();
            const tbody = document.getElementById("positions");
            tbody.innerHTML = "";

            data.forEach(order => {
                // pick color for profit_pct
                let profitColor = "inherit";
                if (order.profit_pct > 3) profitColor = "rgb(0, 255, 0)";
                else if (order.profit_pct > 2) profitColor = "rgb(0, 225, 0)";
                else if (order.profit_pct > 1) profitColor = "rgb(0, 195, 0)";
                else if (order.profit_pct > 0) profitColor = "rgb(0, 165, 0)";
                else if (order.profit_pct < -3) profitColor = "rgb(255, 0, 0)";
                else if (order.profit_pct < -2) profitColor = "rgb(225, 0, 0)";
                else if (order.profit_pct < -1) profitColor = "rgb(195, 0, 0)";
                else if (order.profit_pct < 0) profitColor = "rgb(165, 0, 0)";

                let profitText = `${order.profit_pct}%&nbsp;&nbsp;&nbsp;üòê`;
                if (order.profit_pct > 0) profitText = `${order.profit_pct}%&nbsp;&nbsp;&nbsp;üî•`;
                else if (order.profit_pct < 0) profitText = `${order.profit_pct}%&nbsp;&nbsp;&nbsp;üôÄ`;

                let stopLossBg = order.needs_adjusting ? "red" : "inherit";

                const tr = document.createElement("tr");

                let priceColor = "yellow";
                const prevPrice = previousData[order.ticker]?.current_price;
                if (prevPrice !== undefined) {
                    if (order.current_price > prevPrice) priceColor = "lime";
                    else if (order.current_price < prevPrice) priceColor = "red";
                }

                tr.innerHTML = `
                    <td><strong>${order.ticker}</strong></td>
                    <td><strong>${order.name}</strong></td>
                    <td style="text-align: right;">${order.quantity}</td>
                    <td style="text-align: center; font-size: 32px; padding: 0px;">${order.currency}</td>
                    <td style="text-align: right; color: ${priceColor};">${order.current_price}</td>
                    <td style="text-align: right;">${order.average_price}</td>
                    <td style="text-align: right; color: ${profitColor};">${profitText}</td>
                    <td style="text-align: center; background-color: ${stopLossBg};">‚õîÔ∏è&nbsp;&nbsp;${order.recommended_stop_loss} (${order.recommended_stop_loss_pct}%)</td>
                    <td style="text-align: center; background-color: ${stopLossBg};">üôà&nbsp;&nbsp;${order.stop_loss_price} (${order.stop_loss_distance_pct}%)</td>
                `;
                tbody.appendChild(tr);

                if (priceColor) {
                    setTimeout(() => {
                        tr.cells[5].style.color = "yellow";
                    }, 600);
                }
                previousData[order.ticker] = { current_price: order.current_price };
            });
        } catch (err) {
            console.error("Fetch error:", err);
        }
    }
    setInterval(fetchData, 20000);
    fetchData();
    </script>
</body>
</html>
